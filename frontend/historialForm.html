<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital - Historial Personal</title>
    <link rel="stylesheet" href="estilos.css">
</head>
<body>
    <nav>
        <ul>
            <li><a href="forms.html">INICIO</a></li>
            <li><a href="agregarPaciente.html">Agregar Paciente</a></li>
            <li id="adjuntosLink"><a href="adjuntosForm.html">Registro Medico de Paciente</a></li>
            <li id="adjuntosLink"><a href="adjuntosForm.html">Adjuntar Exámenes</a></li>
            <li><a href="historialForm.html">Historial Personal</a></li>
        </ul>
    </nav>
    <div id="historialSection" style="display: none;"></div>
    <form id="historialForm">
        <h2>Registro Medico de Paciente</h2>
        <label>ID Paciente:</label><input type="number" id="idPaciente" required>
        <label>Alergias:</label><input type="text" id="alergias" required>
        <label>Enfermedades:</label><input type="text" id="enfermedades" required>
        <button type="submit">Guardar</button>
    </form>
    <button id="logoutBtn">Cerrar Sesión</button>

    <script>
        const historialForm = document.getElementById('historialForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const adjuntosLink = document.getElementById('adjuntosLink');
        let token = localStorage.getItem('token');
        let currentRole = null;

        // Controlar visibilidad inicial y acceso
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentRole = payload.role;
                historialForm.style.display = 'block';
                logoutBtn.style.display = 'block';
                if (currentRole === 0 || currentRole === 1) {
                    adjuntosLink.style.display = 'inline';
                } else {
                    adjuntosLink.style.display = 'none';
                }
            } catch (e) {
                localStorage.removeItem('token');
                window.location.href = 'index.html';
            }
        } else {
            historialForm.style.display = 'none';
            logoutBtn.style.display = 'none';
            adjuntosLink.style.display = 'none';
            window.location.href = 'index.html';
        }

        // Manejar envío de historial
        historialForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!token) return alert('Debes iniciar sesión primero');
            const idPaciente = document.getElementById('idPaciente').value;
            const alergias = document.getElementById('alergias').value;
            const enfermedades = document.getElementById('enfermedades').value;
            const response = await fetch('http://localhost:3000/api/historial-personal', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ idPaciente, alergias, enfermedades })
            });
            const data = await response.json();
            if (data.id) alert(`Historial guardado con ID: ${data.id}`);
            else alert(data.error || 'Error al guardar');
        });

        // Manejar cierre de sesión
        logoutBtn.addEventListener('click', () => {
            token = null;
            currentRole = null;
            localStorage.removeItem('token');
            historialForm.style.display = 'none';
            logoutBtn.style.display = 'none';
            adjuntosLink.style.display = 'none';
            alert('Sesión cerrada');
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>